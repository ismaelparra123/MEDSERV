<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="CodeHim">
    <title>Carrito de compras</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <!-- Style CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <link rel="stylesheet" href="css/demo.css">
    <!--  -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js" integrity="sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js" integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ" crossorigin="anonymous"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/buttons/2.3.3/css/buttons.bootstrap5.min.css"
    /> -->



    <!-- <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    /> -->
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        .btn-primary {
            margin-right: 15px;
            margin-left: 10px;
        }

        .btn-success {
            margin-right: 15px;
            margin-left: 10px;
        }
    </style>

</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
           
            <div class="collapse navbar-collapse " id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    
                    <form action="{% url 'home'%}">
                        <button class="btn btn-primary">Home</button>
                    </form>
                    
                </ul>
            </div>
        </div>
    </nav>


    <main>

        <div class="container">
            <div class="row">
                <div class="col-sm-12 col-md-12 col-lg-6 col-xs-12">
                    <h4 class="badge-pill badge-light mt-3 mb-3 p-2 text-center">Productos</h4>
                    <div class="row">
                        <div class="col-sm-6 col-md-6 col-lg-6 col-xs-6">
                            <div class="shadow-sm card mb-3 product">
                                <img class="product-img" src="/static/core/img/papa1.jpg" alt="prd1"
                                    onmouseover="animateImg(this)" onmouseout="normalImg(this)" />
                                <div class="card-body">
                                    <h5 class="card-title text-info bold product-name">Papa granel/kg</h5>
                                    <p class="card-text text-success product-price">800 clp</p>
                                    <button class="btn badge badge-pill badge-secondary mt-2 float-right" type="button"
                                        data-action="add-to-cart">Agregar</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-6 col-lg-6 col-xs-6">
                            <div class="shadow-sm card mb-3 product">
                                <img class="product-img" src="/static/core/img/palta.jpg" alt="prd2"
                                    onmouseover="animateImg(this)" onmouseout="normalImg(this)" />
                                <div class="card-body">
                                    <h5 class="card-title text-info product-name">Palta Kg</h5>
                                    <p class="card-text text-success product-price">3000 clp</p>
                                    <button class="btn badge badge-pill badge-secondary mt-2 float-right" type="button"
                                        data-action="add-to-cart">Agregar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-6 col-md-6 col-lg-6 col-xs-6">
                            <div class="shadow-sm card mb-3 product">
                                <img class="product-img" src="/static/core/img/tomate.jpg" alt="prd3"
                                    onmouseover="animateImg(this)" onmouseout="normalImg(this)" />
                                <div class="card-body">
                                    <h5 class="card-title text-info product-name">Tomate granel/kg</h5>
                                    <p class="card-text text-success product-price">700 clp</p>
                                    <button class="btn badge badge-pill badge-secondary mt-2 float-right" type="button"
                                        data-action="add-to-cart">Agregar</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-6 col-lg-6 col-xs-6">
                            <div class="shadow-sm card mb-3 product">
                                <img class="product-img" src="/static/core/img/cebolla.jpg" alt="prd2"
                                    onmouseover="animateImg(this)" onmouseout="normalImg(this)" />
                                <div class="card-body">
                                    <h5 class="card-title text-info product-name">Cebolla granel/Kg</h5>
                                    <p class="card-text text-success product-price">1000 clp</p>
                                    <button class="btn badge badge-pill badge-secondary mt-2 float-right" type="button"
                                        data-action="add-to-cart">Agregar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                </div>
                <div class="col-sm-12 col-md-12 col-lg-6 col-xs-12">
                    <h4 class="badge-pill badge-light mt-3 mb-3 p-2 text-center">Carrito</h4>
                    <div class="cart"></div>
                </div>
            </div>
        </div>
        
    </main>


    

    <script>
        "use strict";
        let cart = [];
        let cartTotal = 0;
        const cartDom = document.querySelector(".cart");
        const addtocartbtnDom = document.querySelectorAll('[data-action="add-to-cart"]');

        addtocartbtnDom.forEach(addtocartbtnDom => {
            addtocartbtnDom.addEventListener("click", () => {
                const productDom = addtocartbtnDom.parentNode.parentNode;
                const product = {
                    img: productDom.querySelector(".product-img").getAttribute("src"),
                    name: productDom.querySelector(".product-name").innerText,
                    price: productDom.querySelector(".product-price").innerText,
                    quantity: 1
                };

                const IsinCart = cart.filter(cartItem => cartItem.name === product.name).length > 0;
                if (IsinCart === false) {
                    cartDom.insertAdjacentHTML("beforeend", `
  <div class="d-flex flex-row shadow-sm card cart-items mt-2 mb-3 animated flipInX">
    <div class="p-2">
        <img src="${product.img}" alt="${product.name}" style="max-width: 50px;"/>
    </div>
    <div class="p-2 mt-3">
        <p class="text-info cart_item_name">${product.name}</p>
    </div>
    <div class="p-2 mt-3">
        <p class="text-success cart_item_price">${product.price}</p>
    </div>
    <div class="p-2 mt-3 ml-auto">
        <button class="btn badge badge-secondary" type="button" data-action="increase-item">&plus;
    </div>
    <div class="p-2 mt-3">
      <p class="text-success cart_item_quantity">${product.quantity}</p>
    </div>
    <div class="p-2 mt-3">
      <button class="btn badge badge-info" type="button" data-action="decrease-item">&minus;
    </div>
    <div class="p-2 mt-3">
      <button class="btn badge badge-danger" type="button" data-action="remove-item">&times;
    </div>
  </div> `);

                    if (document.querySelector('.cart-footer') === null) {
                        cartDom.insertAdjacentHTML("afterend", `
      <div class="d-flex flex-row shadow-sm card cart-footer mt-2 mb-3 animated flipInX">
        <div class="p-2">
          <button class="btn badge-danger" type="button" data-action="clear-cart">Limpiar Carrito
        </div>
        <div class="p-2 ml-auto">
          <button class="btn badge-dark" type="button" data-action="check-out">Pagar <span class="pay"></span> 
            &#10137;
        </div>
      </div>`);
                    }

                    addtocartbtnDom.innerText = "Agregado";
                    addtocartbtnDom.disabled = true;
                    cart.push(product);

                    const cartItemsDom = cartDom.querySelectorAll(".cart-items");
                    cartItemsDom.forEach(cartItemDom => {

                        if (cartItemDom.querySelector(".cart_item_name").innerText === product.name) {

                            cartTotal += parseInt(cartItemDom.querySelector(".cart_item_quantity").innerText)
                                * parseInt(cartItemDom.querySelector(".cart_item_price").innerText);
                            document.querySelector('.pay').innerText = cartTotal + " clp.";

                            // increase item in cart
                            cartItemDom.querySelector('[data-action="increase-item"]').addEventListener("click", () => {
                                cart.forEach(cartItem => {
                                    if (cartItem.name === product.name) {
                                        cartItemDom.querySelector(".cart_item_quantity").innerText = ++cartItem.quantity;
                                        cartItemDom.querySelector(".cart_item_price").innerText = parseInt(cartItem.quantity) *
                                            parseInt(cartItem.price) + " clp.";
                                        cartTotal += parseInt(cartItem.price)
                                        document.querySelector('.pay').innerText = cartTotal + " clp.";
                                    }
                                });
                            });

                            // decrease item in cart
                            cartItemDom.querySelector('[data-action="decrease-item"]').addEventListener("click", () => {
                                cart.forEach(cartItem => {
                                    if (cartItem.name === product.name) {
                                        if (cartItem.quantity > 1) {
                                            cartItemDom.querySelector(".cart_item_quantity").innerText = --cartItem.quantity;
                                            cartItemDom.querySelector(".cart_item_price").innerText = parseInt(cartItem.quantity) *
                                                parseInt(cartItem.price) + " clp";
                                            cartTotal -= parseInt(cartItem.price)
                                            document.querySelector('.pay').innerText = cartTotal + " clp";
                                        }
                                    }
                                });
                            });

                            //remove item from cart
                            cartItemDom.querySelector('[data-action="remove-item"]').addEventListener("click", () => {
                                cart.forEach(cartItem => {
                                    if (cartItem.name === product.name) {
                                        cartTotal -= parseInt(cartItemDom.querySelector(".cart_item_price").innerText);
                                        document.querySelector('.pay').innerText = cartTotal + " clp";
                                        cartItemDom.remove();
                                        cart = cart.filter(cartItem => cartItem.name !== product.name);
                                        addtocartbtnDom.innerText = "Add to cart";
                                        addtocartbtnDom.disabled = false;
                                    }
                                    if (cart.length < 1) {
                                        document.querySelector('.cart-footer').remove();
                                    }
                                });
                            });

                            //clear cart
                            document.querySelector('[data-action="clear-cart"]').addEventListener("click", () => {
                                cartItemDom.remove();
                                cart = [];
                                cartTotal = 0;
                                if (document.querySelector('.cart-footer') !== null) {
                                    document.querySelector('.cart-footer').remove();
                                }
                                addtocartbtnDom.innerText = "Add to cart";
                                addtocartbtnDom.disabled = false;
                            });

                            document.querySelector('[data-action="check-out"]').addEventListener("click", () => {
                                if (document.getElementById('paypal-form') === null) {
                                    checkOut();
                                }
                            });
                        }
                    });
                }
            });
        });

        function animateImg(img) {
            img.classList.add("animated", "shake");
        }

        function normalImg(img) {
            img.classList.remove("animated", "shake");
        }

        function checkOut() {
            let paypalHTMLForm = `
  <form id="paypal-form" action="https://www.paypal.com/cgi-bin/webscr" method="post" >
    <input type="hidden" name="cmd" value="_cart">
    <input type="hidden" name="upload" value="1">
    <input type="hidden" name="business" value="gmanish478@gmail.com">
    <input type="hidden" name="currency_code" value="INR">`;

            cart.forEach((cartItem, index) => {
                ++index;
                paypalHTMLForm += ` <input type="hidden" name="item_name_${index}" value="${cartItem.name}">
    <input type="hidden" name="amount_${index}" value="${cartItem.price.replace("Rs.", "")}">
    <input type="hidden" name="quantity_${index}" value="${cartItem.quantity}">`;
            });

            paypalHTMLForm += `<input type="submit" value="PayPal" class="paypal">
  </form><div class="overlay">Please wait...</div>`;
            document.querySelector('body').insertAdjacentHTML("beforeend", paypalHTMLForm);
            document.getElementById("paypal-form").submit();
        }
    </script>
</body>

</html>